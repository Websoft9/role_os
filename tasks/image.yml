- name: Is cloud-init exists
  shell: ls /etc/cloud/cloud.cfg
  ignore_errors: True
  register: result

- debug: var=result.stdout

- name: Install cloud-init
  shell: |
    yum install cloud-init
  when: result.stdout != '/etc/cloud/cloud.cfg'
  
- name: Configure nginx php.conf
  template:
    src: cloud-init.cfg.j2
    dest: /etc/cloud/cloud.cfg

- name: Change PasswordAuthentication
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "PasswordAuthentication no"
    line: "PasswordAuthentication yes"

- name: Set enable login by root
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "#PermitRootLogin yes"
    line: "PermitRootLogin yes"

- name: Restart sshd
  shell: systemctl restart sshd
  
  
  
  
- name: Install packages for image importer of Aliyun
  shell: |
    yum install qemu-kvm virt-manager libvirt virt-install openssh-askpass -y

- name: Install aegis
  shell: |
    wget {{ os_aegis_download_url }} && chmod +x AliAqsInstall_64.sh && ./AliAqsInstall_64.sh sJmepE  2>/dev/null
    test -d /usr/local/aegis && bash /usr/local/aegis/aegis_install.sh 
